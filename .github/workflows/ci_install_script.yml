name: CI Install Script

on:
    push:
        branches:
            - main
        paths:
            - "docs/public/install.sh"
            - ".github/workflows/ci_install_script.yml"
    pull_request:
        branches:
            - main
        paths:
            - "docs/public/install.sh"
            - ".github/workflows/ci_install_script.yml"
    workflow_dispatch:

jobs:
    test-install-script:
        name: Test install.sh (${{ matrix.os }})
        runs-on: ${{ matrix.os }}
        strategy:
            matrix:
                include:
                    - os: ubuntu-latest
                      exe_name: tombi
                    - os: macos-latest
                      exe_name: tombi
                    - os: windows-latest
                      exe_name: tombi.exe
            fail-fast: false
        defaults:
            run:
                shell: bash
        steps:
            - uses: actions/checkout@v4

            - name: Run install script
              run: |
                  chmod +x ./docs/public/install.sh
                  ./docs/public/install.sh
              env:
                  GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

            - name: Verify tombi binary exists
              run: |
                  test -f "$HOME/.local/bin/${{ matrix.exe_name }}"
                  echo "Binary found at $HOME/.local/bin/${{ matrix.exe_name }}"

            - name: Verify tombi command works
              run: |
                  export PATH="$HOME/.local/bin:$PATH"
                  ${{ matrix.exe_name }} --version
                  ${{ matrix.exe_name }} --help

    test-install-script-with-options:
        name: Test install.sh with options (${{ matrix.os }})
        runs-on: ${{ matrix.os }}
        strategy:
            matrix:
                include:
                    - os: ubuntu-latest
                      exe_name: tombi
                    - os: macos-latest
                      exe_name: tombi
                    - os: windows-latest
                      exe_name: tombi.exe
            fail-fast: false
        defaults:
            run:
                shell: bash
        steps:
            - uses: actions/checkout@v4

            - name: Create custom install directory
              run: mkdir -p "$HOME/custom-bin"

            - name: Run install script with --install-dir option
              run: |
                  chmod +x ./docs/public/install.sh
                  ./docs/public/install.sh --install-dir "$HOME/custom-bin"
              env:
                  GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

            - name: Verify tombi installed in custom directory
              run: |
                  test -f "$HOME/custom-bin/${{ matrix.exe_name }}"
                  echo "Binary found at $HOME/custom-bin/${{ matrix.exe_name }}"

            - name: Verify tombi command works from custom directory
              run: |
                  export PATH="$HOME/custom-bin:$PATH"
                  ${{ matrix.exe_name }} --version
                  ${{ matrix.exe_name }} --help

    success-install-script:
        runs-on: ubuntu-latest
        needs: [test-install-script, test-install-script-with-options]
        steps:
            - run: echo "All install script tests succeeded!"
